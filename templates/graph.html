<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>財務データグラフ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

{% include "header.html" %}

<div class="container">
  <h2>財務データ可視化</h2>

  <div class="section-box">
    <div class="actions-row">
      <a class="btn" href="{{ url_for('view_data') }}">データ一覧へ</a>
      <a class="btn" href="{{ url_for('index') }}">入力へ</a>
    </div>
  </div>

  <div class="card">
    <div class="section-box">
      <div class="form-row">
        <label>企業</label>
        <select id="companySelect"></select>
      </div>

      <div class="form-row">
        <label>指標</label>
        <select id="metricSelect">
          <option value="sales">売上高</option>
          <option value="roe">ROE</option>
          <option value="productivity">労働生産性</option>
        </select>
      </div>
    </div>

    <div class="chart-card">
      <canvas id="chart"></canvas>
    </div>
  </div>
</div>

<script>
const raw = {{ rows|tojson }};

raw.forEach(r=>{
  r.year = Number(r.year);
  r.sales = Number(r.sales);
  r.roe = Number(r.roe);
  r.productivity = Number(r.productivity);
});

const companies = [...new Set(raw.map(r=>r.company_name))];
const companySel = document.getElementById("companySelect");

companies.forEach(c=>{
  const o = document.createElement("option");
  o.value = c;
  o.textContent = c;
  companySel.appendChild(o);
});

let chart;

function draw(){
  const company = companySel.value;
  const metric = document.getElementById("metricSelect").value;

  const data = raw
    .filter(r=>r.company_name===company)
    .sort((a,b)=>a.year-b.year);

  const labels = data.map(r=>r.year);

  // 指標の表示ラベル
  const metricLabelMap = {
    sales: "売上高（円）",
    roe: "ROE（%）",
    productivity: "労働生産性（円）"
  };

  // 値の加工（ROEは%表示に合わせる）
  const values = data.map(r=>{
    if(metric==="roe") return r[metric] * 100;
    return r[metric];
  });

  if(chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"),{
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: metricLabelMap[metric] || metric,
        data: values
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(v){
              if(metric==="roe") return v + "%";
              // 金額系は3桁区切り
              const n = Number(v);
              if(Number.isFinite(n)) return n.toLocaleString();
              return v;
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx){
              const v = ctx.parsed.y;
              if(metric==="roe") return (Number(v).toFixed(2)) + "%";
              const n = Number(v);
              return Number.isFinite(n) ? n.toLocaleString() + " 円" : String(v);
            }
          }
        }
      }
    }
  });
}

companySel.onchange = draw;
document.getElementById("metricSelect").onchange = draw;

// 初期選択（企業が0件のときは描画しない）
if(companies.length){
  companySel.value = companies[0];
  draw();
}
</script>

</body>
</html>
