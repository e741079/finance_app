<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>財務データ入力</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

{% include "header.html" %}

<div class="container">
  <h1>財務データ入力</h1>

  <div class="actions-row">
    <a class="btn" href="{{ url_for('view_data') }}">データ一覧へ</a>
  </div>

  <form method="POST" class="card" onsubmit="cleanFormBeforeSubmit()">

    <div class="section-box">
      <h3>基本情報</h3>

      <div class="form-row">
        <label>企業名</label>
        <input id="company_name" name="company_name" list="company_suggestions" autocomplete="off" required>
        <datalist id="company_suggestions"></datalist>
      </div>

      <div class="form-row">
        <label>業種</label>
        <input name="industry" id="industryInput" list="industryList" required>
        <datalist id="industryList"></datalist>
      </div>

      <div class="form-row">
        <label>年度</label>
        <select name="year" required>
          {% for y in range(current_year, current_year - 30, -1) %}
            <option value="{{ y }}">{{ y }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-row">
        <label>入力単位</label>
        <select name="unit" required>
          <option value="1">円</option>
          <option value="1000">千円</option>
          <option value="1000000">百万円</option>
        </select>
      </div>
    </div>

    <div class="section-box">
      <h3>財務数値</h3>

      {% set fields = [
        ('sales','売上高'),
        ('gross_profit','売上総利益'),
        ('net_income','当期純利益'),
        ('total_assets','総資産'),
        ('equity','自己資本'),
        ('current_assets','流動資産'),
        ('current_liabilities','流動負債'),
        ('liabilities','総負債')
      ] %}

      {% for name,label in fields %}
        <div class="form-row">
          <label>{{ label }}</label>
          <input name="{{ name }}" class="number-input" inputmode="numeric" required>
        </div>
      {% endfor %}

      <div class="form-row">
        <label>従業員数</label>
        <input name="employees" type="number" min="0" step="1" required>
      </div>

      <div class="actions-row">
        <button type="submit" class="btn">保存</button>
        <a class="btn" href="{{ url_for('view_data') }}">一覧で確認</a>
      </div>
    </div>

  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

  // 企業名候補（/get_companies が必要）
  const input=document.getElementById("company_name");
  const list=document.getElementById("company_suggestions");

  input.addEventListener("input",()=>{
    const q = input.value.trim();
    fetch(`/get_companies?query=${encodeURIComponent(q)}`)
      .then(r=>r.json())
      .then(data=>{
        list.innerHTML="";
        (data||[]).forEach(c=>{
          const o=document.createElement("option");
          o.value=c;
          list.appendChild(o);
        });
      })
      .catch(()=>{ /* 失敗時は何もしない */ });
  });

  // 3桁カンマ
  document.querySelectorAll(".number-input").forEach(i=>{
    i.addEventListener("input",()=>{
      const v=i.value.replace(/,/g,'');
      if(!isNaN(v) && v!=="") i.value=Number(v).toLocaleString();
    });
  });
});

function cleanFormBeforeSubmit(){
  document.querySelectorAll(".number-input").forEach(i=>{
    i.value=i.value.replace(/,/g,'');
  });
}
</script>

</body>
</html>
