<!DOCTYPE html>
<html lang="ja">
<head>
  {% include "header.html" %}
  <meta charset="UTF-8">
  <title>è²¡å‹™ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

<div class="container">
  <h1>è²¡å‹™ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h1>

  <div class="section-box">
    <form method="get">
      <div class="form-row">
        <label>ä¼æ¥­å</label>
        <input name="company_name" value="{{ company_name }}">
      </div>

      <div class="form-row">
        <label>æ¥­ç¨®</label>
        <input name="industry" value="{{ industry }}">
      </div>

      <div class="actions-row">
        <button class="btn" type="submit">æ¤œç´¢</button>
        <a class="btn" href="{{ url_for('download_excel') }}">Excelå‡ºåŠ›</a>
        <a class="btn" href="{{ url_for('graph_view') }}">ğŸ“Š ã‚°ãƒ©ãƒ•ã§æ¯”è¼ƒ</a>
      </div>
    </form>
  </div>

  <div class="table-wrap">
    <table id="financialTable">
      <thead>
        <tr>
          <th>ä¼æ¥­å</th>
          <th>æ¥­ç¨®</th>
          <th>å¹´åº¦</th>

          <th>å£²ä¸Šé«˜</th>
          <th>å£²ä¸Šç·åˆ©ç›Š</th>
          <th>å½“æœŸç´”åˆ©ç›Š</th>

          <th>å£²ä¸Šç·åˆ©ç›Šç‡</th>
          <th>ROE</th>

          <th>ç·è³‡ç”£</th>
          <th>è‡ªå·±è³‡æœ¬</th>
          <th>æµå‹•è³‡ç”£</th>
          <th>æµå‹•è² å‚µ</th>
          <th>ç·è² å‚µ</th>

          <th>æµå‹•æ¯”ç‡</th>
          <th>è² å‚µæ¯”ç‡</th>

          <th>å¾“æ¥­å“¡æ•°</th>
          <th>ä¸€äººã‚ãŸã‚Šå£²ä¸Šé«˜</th>
          <th>åŠ´åƒç”Ÿç”£æ€§</th>

          <th>ç·¨é›†</th>
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
        </tr>
      </thead>

      <tbody>
      {% for row in financial_data %}
        <tr>
          <td>{{ row[1] }}</td>
          <td>{{ row[2] }}</td>
          <td>{{ row[3] }}</td>

          <td>{{ "{:,}".format(row[4]|int) }}</td>
          <td class="profit">{{ "{:,}".format(row[5]|int) }}</td>
          <td class="profit">{{ "{:,}".format(row[6]|int) }}</td>

          <td class="profit">{{ "%.2f"|format(row[13]*100) }}%</td>
          <td class="profit">{{ "%.2f"|format(row[14]*100) }}%</td>

          <td class="stable">{{ "{:,}".format(row[7]|int) }}</td>
          <td class="stable">{{ "{:,}".format(row[8]|int) }}</td>
          <td class="stable">{{ "{:,}".format(row[9]|int) }}</td>
          <td class="stable">{{ "{:,}".format(row[10]|int) }}</td>
          <td class="stable">{{ "{:,}".format(row[11]|int) }}</td>

          <td class="stable">
            {% set r=row[15]*100 %}
            {% if r>=120 %}<span class="good">â—</span>{% elif r>=100 %}<span class="warn">â—</span>{% else %}<span class="bad">â—</span>{% endif %}
            {{ "%.2f"|format(r) }}%
          </td>

          <td class="stable">
            {% set r=row[16]*100 %}
            {% if r>=120 %}<span class="good">â—</span>{% elif r>=100 %}<span class="warn">â—</span>{% else %}<span class="bad">â—</span>{% endif %}
            {{ "%.2f"|format(r) }}%
          </td>

          <td class="produce">{{ "{:,}".format(row[12]|int) }}</td>
          <td class="produce">{{ "{:,}".format(row[17]|int) }}</td>
          <td class="produce">{{ "{:,}".format(row[18]|int) }}</td>

          <td><a class="btn" href="{{ url_for('edit_data', id=row[0]) }}">ç·¨é›†</a></td>

          <td class="comments-cell">
            {% if comments_by_id and row[0] in comments_by_id %}
              {% for c in comments_by_id[row[0]] %}
                <div class="comment-view">{{ c[3] }}</div>
              {% endfor %}
            {% else %}
              <span class="muted">ãªã—</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.querySelectorAll("#financialTable th").forEach((th,i)=>{
  th.onclick=()=>sortTable(i);
});
let dir={};
function sortTable(i){
  const tb=document.querySelector("#financialTable tbody");
  const rows=[...tb.rows];
  dir[i]=dir[i]==="asc"?"desc":"asc";
  rows.sort((a,b)=>{
    let x=a.cells[i].innerText.replace(/,/g,'').replace('%','');
    let y=b.cells[i].innerText.replace(/,/g,'').replace('%','');
    x=parseFloat(x)||x; y=parseFloat(y)||y;
    return (x<y?-1:1)*(dir[i]==="asc"?1:-1);
  });
  rows.forEach(r=>tb.appendChild(r));
}
</script>

</body>
</html>
